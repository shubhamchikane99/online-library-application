<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Assign Book To User</title>
	<style>
		body {
			font-family: Arial;
			background: #f4f6f9;
			padding: 40px;
		}

		.container {
			width: 800px;
			margin: auto;
		}

		.card {
			background: white;
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 30px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
		}

		h2 {
			text-align: center;
			margin-bottom: 20px;
		}

		select,
		input,
		button {
			width: 100%;
			padding: 10px;
			margin: 10px 0;
			border-radius: 5px;
			border: 1px solid #ccc;
		}

		button {
			background: #4e73df;
			color: white;
			border: none;
			cursor: pointer;
		}

		button:hover {
			background: #2e59d9;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			background: white;
		}

		th,
		td {
			padding: 10px;
			border: 1px solid #ddd;
			text-align: center;
		}

		th {
			background: #4e73df;
			color: white;
		}

		.return-btn {
			background: green;
			color: white;
			padding: 5px 10px;
			border-radius: 4px;
			text-decoration: none;
		}

		#message {
			text-align: center;
			font-weight: bold;
			margin-bottom: 15px;
		}
	</style>
</head>

<body>

	<div class="container">

		<p id="message"></p>

		<!-- Assign Section -->
		<div class="card">
			<h2>Assign Book To User</h2>

			<form id="assignForm" action="/assign-book-to-user" method="post" onsubmit="return validateForm()">

				<!-- Select User -->
				<select id="userId" name="userId" required>
					<option value="">Select User</option>
					<option th:each="u : ${userList}" th:value="${u.id}" th:text="${u.name}"
						th:data-membership-remaining="${u.dayRemaing}">
					</option>
				</select>

				<!-- Select Book -->
				<select id="bookId" name="bookId" required>
					<option value="">Select Book</option>
					<option th:each="b : ${bookList}" th:value="${b.id}" th:text="${b.name}"
						th:data-status="${b.status}"></option>
				</select>

				<!-- Issue Date -->
				<input type="date" id="fromIssueDate" name="fromIssueDate" required>

				<!-- Expected Return Date -->
				<input type="date" id="toIssueDate" name="toIssueDate" required>

				<button type="submit">Assign Book</button>

			</form>
		</div>

		<!-- Issued Books Table -->
		<h2>Currently Issued Books</h2>

		<table>
			<thead>
				<tr>
					<th>User</th>
					<th>Book</th>
					<th>From Issue Date</th>
					<th>To Issue Date</th>
					<th>Status</th>
					<th>Action</th>
				</tr>
			</thead>

			<tbody>
				<tr th:each="assign : ${assingBookList}">

					<td th:text="${assign.userName}">User Name</td>

					<td th:text="${assign.bookName}">Book Name</td>

					<td th:text="${assign.fromIssueDate}">Issue Date</td>

					<td th:text="${assign.toIssueDate}">Issue Date</td>

					<td>
						<span th:if="${assign.status == 0}" style="color:orange;">Issued</span>
						<span th:if="${assign.status == 1}" style="color:green;">Returned</span>
					</td>

					<td>
						<a th:if="${assign.status == 0}" th:href="@{/return-book/{id}(id=${assign.id})}"
							class="return-btn">
							Return
						</a>

						<span th:if="${assign.status == 1}" style="color:gray;">
							Completed
						</span>
					</td>

				</tr>
			</tbody>
		</table>

	</div>

	<script>
		function validateForm() {

			let message = document.getElementById("message");
			message.innerHTML = "";

			let today = new Date();
			today.setHours(0, 0, 0, 0);

			// ✅ Correct User Select ID
			let userSelect = document.getElementById("userId");
			let selectedUserOption = userSelect.options[userSelect.selectedIndex];

			let user = {
				id: selectedUserOption.value,
				name: selectedUserOption.text,
				membershipRemaining: parseInt(selectedUserOption.dataset.membershipRemaining || 0)
			};

			// ✅ Correct Book Select ID
			let bookSelect = document.getElementById("bookId");
			let selectedBookOption = bookSelect.options[bookSelect.selectedIndex];

			let book = {
				id: selectedBookOption.value,
				name: selectedBookOption.text
			};

			// ✅ Correct Date IDs
			let issueDate = new Date(document.getElementById("fromIssueDate").value);
			let returnDate = new Date(document.getElementById("toIssueDate").value);

			// Validate empty selection
			if (!user.id || !book.id) {
				message.innerHTML = "Please select user and book.";
				message.style.color = "red";
				return false;
			}

			// Date validation
			if (issueDate < today) {
				message.innerHTML = "Issue date cannot be in the past!";
				message.style.color = "red";
				return false;
			}

			if (returnDate <= issueDate) {
				message.innerHTML = "Return date must be after issue date!";
				message.style.color = "red";
				return false;
			}

			// Difference in days
			let diffDays = Math.ceil((returnDate - issueDate) / (1000 * 60 * 60 * 24));

			// 1️⃣ Membership expired
			if (user.membershipRemaining <= 0) {
				message.innerHTML = "Cannot issue book. User '" + user.name + "' membership is expired.";
				message.style.color = "red";
				return false;
			}

			// 2️⃣ Not enough membership days
			if (diffDays > user.membershipRemaining) {
				message.innerHTML = "Cannot issue book. User '" + user.name + "' has only " +
					user.membershipRemaining + " day(s) left, but you selected " +
					diffDays + " day(s).";
				message.style.color = "red";
				return false;
			}

			// Success
			message.innerHTML = "Book '" + book.name + "' assigned successfully.";
			message.style.color = "green";

			return true;
		}
	</script>

</body>

</html>